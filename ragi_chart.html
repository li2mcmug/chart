<!DOCTYPE html>
<html>
<head>
<!-- Load the Paper.js library -->
<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/underscore.js"></script>
<script type="text/javascript" src="js/paper.js"></script>
<script type="text/javascript" src="js/opentip-jquery.js"></script>
<link href="css/opentip.css" rel="stylesheet" type="text/css" />
<!-- Define inlined PaperScript associate it with myCanvas -->
<script type="text/paperscript" canvas="myCanvas">

var maxHeight = 800;
var incr = 0.3;
var path = new Path();
var dateMap = {};

var hitOptions = { fill: true, stroke: false, segments: true, tolerance: 5, type: Point };

var priceTip  = $("#price-tooltip");
var priceOpentip = new Opentip(priceTip, { showOn: null, style: 'alert' });

$(document).ready(function() {
    $.ajax({
        type: "GET",
        async: false,
        url: "TEST.csv",
        dataType: "text",
        success: function(data) {drawGraph(data);}
     });


});

function setupPath(){
  path.strokeColor = 'black';
  path.fullySelected = true;
  path.strokeWidth = 5;
}

function pointKey(point){
  return point.x + "," + point.y;
}

function drawHorizontalLine(path, lastPoint){
  var date = dateMap[pointKey(lastPoint)];

  lastPoint = new Point(lastPoint.x + 20, lastPoint.y);
  path.lineTo(lastPoint);
  dateMap[pointKey(lastPoint)] = date;
  return lastPoint;
}

function addPoint(path, lastPoint, date, value){
  lastPoint = new Point(lastPoint.x, maxHeight - value);
  path.lineTo(lastPoint);
  dateMap[pointKey(lastPoint)] = date;
  return lastPoint;
}

function onMouseMove(event) {
  var hitResult = path.hitTest(event.point, hitOptions);

  if(hitResult) {
    var point = hitResult.segment.point;
    var y = point.y;
    //alert(y.data.value);
    value = (maxHeight - parseInt(y)) / 100;
    priceOpentip.setContent(dateMap[pointKey(point)] + ", " + value);
    priceOpentip.show();
  }
}



function drawGraph(allText) {
  var count = 0, lastPoint, baseValue, trend, originalValue, prevLow, prevHigh, value, date;
  setupPath();

  incr = incr * 100;

  var allLines = allText.split(/\r\n|\n/);
  allLines = allLines.reverse();
  _.each(allLines, function(line) {
  value = line;
     var values = line.split(/,/);
     date = values[0].replace(/\"/g, "");
     value = values[1];
     originalValue = value;
     value = value * 100;


     if(count === 0) {
	   var start = new Point(100, value);
	   lastPoint = start;
	   baseValue = value;
	   lastPoint.y = maxHeight - lastPoint.y;
	   path.moveTo(lastPoint);
	   trend = null;
     } else {
        if(count === 1) {
          if(value > baseValue) { trend = "up"; }
          if(value < baseValue) { trend = "down"; }
        }
     	if(value > (baseValue + incr) && (trend === "down" || _.isNull(trend)) ) {
     	  prevLow = baseValue;
     	  baseValue = value;
          lastPoint = drawHorizontalLine(path, lastPoint);
          lastPoint = addPoint(path, lastPoint, date, value);
          trend = "up";
        }
        else if(value < (baseValue - incr) && (trend === "up" || _.isNull(trend)) ) {
          prevHigh = baseValue;
	      baseValue = value;
	      lastPoint = drawHorizontalLine(path, lastPoint);
	      lastPoint = addPoint(path, lastPoint, date, value);
	      trend = "down";
        }
        else if((value > baseValue && trend === "up") || (value < baseValue && trend === "down")) {
		  baseValue = value;
		  lastPoint = addPoint(path, lastPoint, date, value);
        }
     }
    count++;
  });
};


</script>
</head>
<body>
    <canvas id="myCanvas" resize></canvas>
    <div id="price-tooltip"></div>
    <div data-ot="Shown after 2 seconds" data-ot-delay="2"></div>
</body>
</html>