<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="css/jquery-ui.css">
    <script type="text/javascript" src="js/underscore.js"></script>
    <script type="text/javascript" src="js/d3.js"></script>
    <script type="text/javascript" src="js/jquery.js"></script>
    <script type="text/javascript" src="js/jquery-ui.js"></script>
    <script type="text/javascript">
      var width = 1250;
      var height = 500;
      String.prototype.format = function () {
          var formatted = this;
          for (var i = 0; i < arguments.length; i++) {
              var regexp = new RegExp('\\{' + i + '\\}', 'gi');
              formatted = formatted.replace(regexp, arguments[i]);
          }
          return formatted;
      };

      function min(a, b) {
          return a < b ? a : b;
      }

      function max(a, b) {
          return a > b ? a : b;
      }

      function buildChart(data) {
          $("#chart").empty();

          var margin = 50;

          var chart = d3.select("#chart")
              .append("svg:svg")
              .attr("class", "chart")
              .attr("width", width)
              .attr("height", height);

          var y = d3.scale.linear()
              .domain([d3.min(data.map(function (x) {
                  return x["Low"];
              })), d3.max(data.map(function (x) {
                  return x["High"];
              }))])
              .range([height - margin, margin]);
          var x = d3.scale.linear()
              .domain([d3.min(data.map(function (d) {
                  return d.timestamp;
              })), d3.max(data.map(function (d) {
                  return d.timestamp;
              }))])
              .range([margin, width - margin]);

          chart.selectAll("line.x")
              .data(x.ticks(10))
              .enter().append("svg:line")
              .attr("class", "x")
              .attr("x1", x)
              .attr("x2", x)
              .attr("y1", margin)
              .attr("y2", height - margin)
              .attr("stroke", "#ccc");

          chart.selectAll("line.y")
              .data(y.ticks(10))
              .enter().append("svg:line")
              .attr("class", "y")
              .attr("x1", margin)
              .attr("x2", width - margin)
              .attr("y1", y)
              .attr("y2", y)
              .attr("stroke", "#ccc");

          chart.selectAll("text.xrule")
              .data(x.ticks(10))
              .enter().append("svg:text")
              .attr("class", "xrule")
              .attr("x", x)
              .attr("y", height - margin)
              .attr("dy", 20)
              .attr("text-anchor", "middle")
              .text(function (d) {
                  var date = new Date(d * 1000);
                  return (date.getMonth() + 1) + "/" + date.getDate();
              });

          chart.selectAll("text.yrule")
              .data(y.ticks(10))
              .enter().append("svg:text")
              .attr("class", "yrule")
              .attr("x", width - margin)
              .attr("y", y)
              .attr("dy", 0)
              .attr("dx", 20)
              .attr("text-anchor", "middle")
              .text(String);

          chart.selectAll("rect")
              .data(data)
              .enter().append("svg:rect")
              .attr("x", function (d) {
                  return x(d.timestamp);
              })
              .attr("y", function (d) {
                  return y(max(d.Open, d.Close));
              })
              .attr("height", function (d) {
                  return y(min(d.Open, d.Close)) - y(max(d.Open, d.Close));
              })
              .attr("width", function (d) {
                  return 0.5 * (width - 2 * margin) / data.length;
              })
              .attr("fill", function (d) {
                  return d.Open > d.Close ? "red" : "green";
              });

          chart.selectAll("line.stem")
              .data(data)
              .enter().append("svg:line")
              .attr("class", "stem")
              .attr("x1", function (d) {
                  return x(d.timestamp) + 0.25 * (width - 2 * margin) / data.length;
              })
              .attr("x2", function (d) {
                  return x(d.timestamp) + 0.25 * (width - 2 * margin) / data.length;
              })
              .attr("y1", function (d) {
                  return y(d.High);
              })
              .attr("y2", function (d) {
                  return y(d.Low);
              })
              .attr("stroke", function (d) {
                  return d.Open > d.Close ? "red" : "green";
              })

      }


      function fetchData() {
          var last_date = '2013-11-01';
          var symbol = $("#symbol").val();
      	  var max_days = 180;

          result = new Array();
          $.ajax({
            type: "GET",
            async: false,
            url: "data/" + "AAPL" + ".csv",
            dataType: "text",
            success: function(content) {
              var lines = content.split(/\r\n|\n/);
              var i = 0, found = false;
              _.each(lines, function(line) {
                var fields = line.split(",");
                date = fields[0];

                if(date == last_date) {
                  found = true;
                }

                if(found && i < max_days) {
                  result[i] = {"timestamp": (new Date(date).getTime() / 1000), "date":date,"Date":date,"Open":fields[1],"High":fields[2],"Low":fields[3],"Close":fields[4],"Volume":fields[5],"Adj_Close":fields[6]};
                  i = i + 1;
                }

              });
            }
          });
          buildChart(result);
      }


      $(document).ready(function() {
        $( "#datepicker" ).datepicker();
        fetchData();
      });

    </script>

  </head>
  <body>
    <div id="chart"></div>
    <form>
    	<label for"symbol">Symbol</label>
    	<input type="text" id="symbol" name="symbol" />

        <label for="date">Date</label>
		<input onclick="fetchData();" type="text" name="date" id="datepicker" />
    </form>
  </body>
</html>
